---
layout: default
---
<header class="post-header">
  <div class="row">
    <div class="col col-lg-10">
      <h1 class="post-title">WotV Accuracy Calculator</h1>
    </div>
    <div class="col col-lg-2 text-end">
      <span data-bs-toggle="modal" data-bs-target="#statueMasteryModal">
        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Statues & Masteries">
          <i class="bi bi-trophy" style="font-size: 1.5rem;"></i>
        </button>
      </span>
    </div>
  </div>
</header>

<div class="post-content">
  <div class="container">
    
    <div class="row justify-content-md-center">
      <div class="col col-lg-3">
        
        <!--Attacker-->
        <h1 class="display-1 text-center">Attacker</h1>
        <div class="mb-3">
          <img id="atkUnitImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" style="width:250px;height:250px;object-fit:none;object-position: 50% 35%;"></i>
        </div>
        <select id="atkUnitDropdown" class="form-select mb-3" aria-label="attack-unit">
          <option selected disabled hidden>Choose Unit</option>
        </select>
        <div class="mb-3" style="position: relative; width: 300px; height: 125px; overflow: hidden;">
          <img id="atkEsperImg" class="position-absolute translate-middle" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" style="left: 25%; top: 70%"></i>
          <button class="btn btn-outline-secondary position-absolute translate-middle top-50" style="right: 15%" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Esper Board">
            <i class="bi bi-hexagon" style="font-size: 1.5rem;"></i>
          </button>
        </div>
        <select id="atkEsperDropdown" class="form-select mb-3" aria-label="defend-esper">
          <option selected disabled hidden>Choose Esper</option>
        </select>
        <div class="row mb-3" style="height: 111px">
          <div class="col-lg-6">
            <img id="atkVCImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="></i>
          </div>
          <div class="col-lg-6">
            <img id="atkSubVCImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="></i>
          </div>
        </div>
        <div class="form-floating">
          <select id="atkVCDropdown" class="form-select mb-3" aria-label="attack-vision-card">
            <option selected disabled hidden>Choose Vision Card</option>
          </select>
          <label for="atkVCDropdown" style="color:#212529">Main Vision Card</label>
        </div>
        <!-- <select id="atkVCDropdown" class="form-select mb-3" aria-label="attack-vision-card">
          <option selected disabled hidden>Choose Vision Card</option>
        </select> -->
        <select id="atkSubVCDropdown" class="form-select mb-3" aria-label="attack-subvision-card" disabled>
          <option selected disabled hidden>Choose Sub-Vision Card</option>
        </select>
        <div class="mb-3">
          <label for="atkDexInput" class="form-label">DEX</label>
          <input type="number" class="form-control" id="atkDexInput" placeholder=0>
        </div>
        <div class="mb-3">
          <label for="atkLukInput" class="form-label">LUK</label>
          <input type="number" class="form-control" id="atkLukInput" placeholder=0>
        </div>
        <div id="accBase">-100</div>

      </div>
      <div class="col col-lg-5 pt-3">
        
        <!--Middle-->
        <h1 class="display-1 text-center"><span id="hitRate" >0</span>%</h1>

      </div>
      <div class="col col-lg-3">
        
        <!--Defender-->
        <h1 class="display-1 text-center">Defender</h1>
        <div class="mb-3">
          <img id="defUnitImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" style="width:250px;height:250px;object-fit:none;object-position: 50% 35%;"></i>
        </div>
        <select id="defUnitDropdown" class="form-select mb-3" aria-label="defend-unit">
          <option selected disabled hidden>Choose Unit</option>
        </select>
        <div class="mb-3" style="position: relative; width: 300px; height: 125px; overflow: hidden;">
          <img id="defEsperImg" class="position-absolute translate-middle" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" style="left: 25%; top: 70%"></i>
          <button class="btn btn-outline-secondary position-absolute translate-middle top-50" style="right: 15%" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Esper Board">
            <i class="bi bi-hexagon" style="font-size: 1.5rem;"></i>
          </button>
        </div>
        <select id="defEsperDropdown" class="form-select mb-3" aria-label="defend-esper">
          <option selected disabled hidden>Choose Esper</option>
        </select>
        <div class="row mb-3" style="height: 111px">
          <div class="col-lg-6">
            <img id="defVCImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="></i>
          </div>
          <div class="col-lg-6">
            <img id="defSubVCImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="></i>
          </div>
        </div>
        <div class="form-floating">
          <select id="defVCDropdown" class="form-select mb-3" aria-label="defend-vision-card">
            <option selected disabled hidden>Choose Vision Card</option>
          </select>
          <label for="defVCDropdown" style="color:#212529">Main Vision Card</label>
        </div>
        <!-- <select id="defVCDropdown" class="form-select mb-3" aria-label="defend-vision-card">
          <option selected disabled hidden>Choose Vision Card</option>
        </select> -->
        <select id="defSubVCDropdown" class="form-select mb-3" aria-label="defend-subvision-card" disabled>
          <option selected disabled hidden>Choose Sub-Vision Card</option>
        </select>
        <div class="mb-3">
          <label for="defAgiInput" class="form-label">AGI</label>
          <input type="number" class="form-control" id="defAgiInput" placeholder=0>
        </div>
        <div class="mb-3">
          <label for="defLukInput" class="form-label">LUK</label>
          <input type="number" class="form-control" id="defLukInput" placeholder=0>
        </div>
        <div id="evaBase">-100</div>

      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="statueMasteryModal" tabindex="-1" aria-labelledby="statueMasteryModallLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content"  style="background-color: #212529">
      <div class="modal-header">
        <h5 class="modal-title" id="statueMasteryModalLabel">Guild Stone Statues & Elemental Masteries</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-4">
        <div class="row px-4">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="copyStatueMasterySwitch">
            <label class="form-check-label" for="copyStatueMasterySwitch">Apply same stats to both attacker and defender</label>
          </div>
        </div>
        <hr>
        <div class="row justify-content-md-center">
          <div class="col col-lg-4 d-flex justify-content-md-center">
            <h6>Attacker</h6>
          </div>
          <div class="col col-lg-4">
          </div>
          <div class="col col-lg-4 d-flex justify-content-md-center">
            <h6>Defender</h6>
        </div>
        <div class="row justify-content-md-center">
          <div class="col col-lg-3">
            <select id="atkBullStatue" class="form-select mb-3" aria-label="attack-bull-statue">
            </select>
          </div>
          <div class="col col-lg-6 d-flex justify-content-center align-items-center">
            <h6>Bull Stone Statue</h6>
          </div>
          <div class="col col-lg-3">
            <select id="defBullStatue" class="form-select mb-3" aria-label="defend-bull-statue">
            </select>
          </div>
        </div>
        <div class="row justify-content-md-center">
          <div class="col col-lg-3">
            <select id="atkLionStatue" class="form-select mb-3" aria-label="attack-lion-statue">
            </select>
          </div>
          <div class="col col-lg-6 d-flex justify-content-center align-items-center">
            <h6>Lion Stone Statue</h6>
          </div>
          <div class="col col-lg-3">
            <select id="defLionStatue" class="form-select mb-3" aria-label="defend-lion-statue">
            </select>
          </div>
        </div>
        <div class="row justify-content-md-center">
          <div class="col col-lg-3">
            <select id="atkKnightStatue" class="form-select mb-3" aria-label="attack-knight-statue">
            </select>
          </div>
          <div class="col col-lg-6 d-flex justify-content-center align-items-center">
            <h6>Knight Stone Statue</h6>
          </div>
          <div class="col col-lg-3">
            <select id="defKnightStatue" class="form-select mb-3" aria-label="defend-knight-statue">
            </select>
          </div>
        </div>
        <div class="row justify-content-md-center">
          <div class="col col-lg-3">
            <select id="atkElementMastery" class="form-select mb-3" aria-label="attack-element-mastery">
            </select>
          </div>
          <div class="col col-lg-6 d-flex justify-content-center align-items-center">
            <h6>Elemental Mastery</h6>
          </div>
          <div class="col col-lg-3">
            <select id="defElementMastery" class="form-select mb-3" aria-label="defend-element-mastery">
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript" src="./assets/js/helper.js"></script>
<script type="text/javascript" src="./assets/js/wotvfunction.js"></script>

<script>
  function populateSelectDropdownWithNumbers(dropdownElementId, count) {
    let dropdown = document.querySelector(dropdownElementId);
    for (let i=1; i<=count; i++) {
      let option = document.createElement("option");
      option.value = i;
      option.text = i;
      dropdown.add(option, null);
    }
  }

  populateSelectDropdownWithNumbers('#atkBullStatue', 10);
  populateSelectDropdownWithNumbers('#defBullStatue', 10);
  populateSelectDropdownWithNumbers('#atkLionStatue', 10);
  populateSelectDropdownWithNumbers('#defLionStatue', 10);
  populateSelectDropdownWithNumbers('#atkKnightStatue', 10);
  populateSelectDropdownWithNumbers('#defKnightStatue', 10);
  populateSelectDropdownWithNumbers('#atkElementMastery', 40);
  populateSelectDropdownWithNumbers('#defElementMastery', 40);

  const copyStatueMasterySwitch = document.querySelector('#copyStatueMasterySwitch');
  const atkBullStatue = document.querySelector('#atkBullStatue');
  const defBullStatue = document.querySelector('#defBullStatue');
  const atkLionStatue = document.querySelector('#atkLionStatue');
  const defLionStatue = document.querySelector('#defLionStatue');
  const atkKnightStatue = document.querySelector('#atkKnightStatue');
  const defKnightStatue = document.querySelector('#defKnightStatue');
  const atkElementMastery = document.querySelector('#atkElementMastery');
  const defElementMastery = document.querySelector('#defElementMastery');

  copyStatueMasterySwitch.addEventListener('change', () => {
    if (copyStatueMasterySwitch.checked) {
      defBullStatue.disabled = true;
      defLionStatue.disabled = true;
      defKnightStatue.disabled = true;
      defElementMastery.disabled = true;
      defBullStatue.value = atkBullStatue.value;
      defLionStatue.value = atkLionStatue.value;
      defKnightStatue.value = atkKnightStatue.value;
      defElementMastery.value = atkElementMastery.value;
    }
    else {
      defBullStatue.disabled = false;
      defLionStatue.disabled = false;
      defKnightStatue.disabled = false;
      defElementMastery.disabled = false;
    }
  });

  atkBullStatue.addEventListener('change', () => {
    if (copyStatueMasterySwitch.checked) {
      defBullStatue.value = atkBullStatue.value;
    }
  });
  atkLionStatue.addEventListener('change', () => {
    if (copyStatueMasterySwitch.checked) {
      defLionStatue.value = atkLionStatue.value;
    }
  });
  atkKnightStatue.addEventListener('change', () => {
    if (copyStatueMasterySwitch.checked) {
      defKnightStatue.value = atkKnightStatue.value;
    }
  });
  atkElementMastery.addEventListener('change', () => {
    if (copyStatueMasterySwitch.checked) {
      defElementMastery.value = atkElementMastery.value;
    }
  });

  function getAccuracyBase(dex, luk) {
    if (dex < 0 || luk < 0) {
      return -100
    } else {
      return (11*(dex**0.2)/20 + (luk**0.96)/200 - 1)*100
    }
  }
  function getEvasionBase(agi, luk) {
    if (agi < 0 || luk < 0) {
      return -100
    } else {
      return (11*Math.pow(agi,0.9)/1000 + Math.pow(luk,0.96)/200 - 1)*100
    }
  }

  const atkDex = document.querySelector('#atkDexInput');
  const atkLuk = document.querySelector('#atkLukInput');
  const accBase = document.querySelector('#accBase');

  const defAgi = document.querySelector('#defAgiInput');
  const defLuk = document.querySelector('#defLukInput');
  const evaBase = document.querySelector('#evaBase');

  const hitRate = document.querySelector('#hitRate');

  function updateAccBase() {
    const acc = getAccuracyBase(Number(atkDex.value), Number(atkLuk.value)).toFixed(0);
    accBase.textContent = acc;
  }

  function updateEvaBase() {
    const eva = getEvasionBase(Number(defAgi.value), Number(defLuk.value)).toFixed(0);
    evaBase.textContent = eva;
  }

  function updateHitRate() {
    const hit = Number(accBase.textContent) - Number(evaBase.textContent);
    hitRate.textContent = hit;
  }

  atkDex.addEventListener('change', () => {updateAccBase(); updateHitRate();});
  atkLuk.addEventListener('change', () => {updateAccBase(); updateHitRate();});
  defAgi.addEventListener('change', () => {updateEvaBase(); updateHitRate();});
  defLuk.addEventListener('change', () => {updateEvaBase(); updateHitRate();});

  function loadUnitDropdown(dropdownElementId) {
    let namePromise = loadJSONPromise('./assets/dump/en/UnitName.json');
    namePromise.then((values) => {
      let nameList = values.infos
      let regex = /_P_/;
      let playerUnits = nameList.filter(unit => regex.test(unit.key));
      let sortedList = playerUnits.sort(dynamicSort("value"));
      let dropdown = document.querySelector(dropdownElementId);
      sortedList.forEach((unit) => {
        let option = document.createElement("option");
        option.value = unit.key;
        option.text = unit.value;
        dropdown.add(option, null);
      });
    });
  }

  loadUnitDropdown("#atkUnitDropdown");
  loadUnitDropdown("#defUnitDropdown");

  function loadVCDropdown(dropdownElementId) {
    let namePromise = loadJSONPromise('./assets/dump/en/VisionCardName.json');
    namePromise.then((values) => {
      let nameList = values.infos
      let regex = /_LW_/;
      let visionCards = nameList.filter(vc => regex.test(vc.key));
      let sortedList = visionCards.sort(dynamicSort("value"));
      let dropdown = document.querySelector(dropdownElementId);
      sortedList.forEach((vc) => {
        let option = document.createElement("option");
        option.value = vc.key;
        option.text = vc.value;
        dropdown.add(option, null);
      });
    });
  }

  loadVCDropdown("#atkVCDropdown");
  loadVCDropdown("#defVCDropdown");

  function loadEsperDropdown(dropdownElementId) { 
    let namePromise = loadJSONPromise('./assets/dump/en/UnitName.json');
    namePromise.then((values) => {
      let nameList = values.infos
      let esperRegex = /_S_/;
      let awakenRegex = /_AW/;
      // Get espers and filter duplicates for different awaken status
      let espers = nameList.filter(esper => (esperRegex.test(esper.key) && !awakenRegex.test(esper.key)));
      let sortedList = espers.sort(dynamicSort("value"));
      let dropdown = document.querySelector(dropdownElementId);
      sortedList.forEach((esper) => {
        let option = document.createElement("option");
        option.value = esper.key;
        option.text = esper.value;
        dropdown.add(option, null);
      });
    });
  }

  loadEsperDropdown("#atkEsperDropdown");
  loadEsperDropdown("#defEsperDropdown");


  let atkUnitDropdown = document.querySelector("#atkUnitDropdown");
  let defUnitDropdown = document.querySelector("#defUnitDropdown");
  atkUnitDropdown.addEventListener('change', (event) => {
    updateStatsOnAtkUnitChange(event.target.value, '#atkDexInput', '#atkLukInput');
    updateImageOnUnitChange(event.target.value, '#atkUnitImg');
  });
  defUnitDropdown.addEventListener('change', (event) => {
    updateStatsOnDefUnitChange(event.target.value, '#defAgiInput', '#defLukInput');
    updateImageOnUnitChange(event.target.value, '#defUnitImg');
  });

  let atkEsperDropdown = document.querySelector("#atkEsperDropdown");
  let defEsperDropdown = document.querySelector("#defEsperDropdown");
  atkEsperDropdown.addEventListener('change', (event) => {
    updateImageOnEsperChange(event.target.value, '#atkEsperImg');
  });
  defEsperDropdown.addEventListener('change', (event) => {
    updateImageOnEsperChange(event.target.value, '#defEsperImg');
  });

  let atkVCDropdown = document.querySelector("#atkVCDropdown");
  let defVCDropdown = document.querySelector("#defVCDropdown");
  atkVCDropdown.addEventListener('change', (event) => {
    updateStatsOnAtkVisionCardChange(event.target.value, '#atkDexInput', '#atkLukInput');
    updateImageOnVCChange(event.target.value, "#atkVCImg");
  });
  defVCDropdown.addEventListener('change', (event) => {
    updateStatsOnAtkVisionCardChange(event.target.value, '#atkDexInput', '#atkLukInput');
    updateImageOnVCChange(event.target.value, "#defVCImg");
  });

  function updateImageOnUnitChange(unitKey, imageElementId) {
    let unitImageDirectory = "assets/dump/img/units/"
    let unitPromise = loadJSONPromise('./assets/dump/data/Unit.json');
    unitPromise.then((values) => {
      let data = parse_AnyData(values,"iname");
      let unit = data.get(unitKey);
      let regex = /_00/
      let fileName;
      if (regex.test(unit.voiceId) || !unit.hasOwnProperty('voiceId')) {
        fileName = unit.charaId;
      }
      else {
        // Handling for units with alternate costumes
        fileName = unit.voiceId;
      }
      let imageRef = unitImageDirectory + fileName + ".png"
      let image = document.querySelector(imageElementId);
      image.src = imageRef;
    });
  }

  function updateImageOnEsperChange(esperKey, imageElementId) {
    let unitImageDirectory = "assets/dump/img/units/"
    let unitPromise = loadJSONPromise('./assets/dump/data/Unit.json');
    unitPromise.then((values) => {
      let data = parse_AnyData(values,"iname");
      let unit = data.get(esperKey);
      let fileName = unit.charaId;
      let imageRef = unitImageDirectory + fileName + ".png"
      let image = document.querySelector(imageElementId);
      image.src = imageRef;
    });
  }

  function updateImageOnVCChange(vcKey, imageElementId) {
    let vcImageDirectory = "assets/dump/img/visioncards/"
    let vcPromise = loadJSONPromise('./assets/dump/data/VisionCard.json');
    vcPromise.then((values) => {
      let data = parse_AnyData(values,"iname");
      let vc = data.get(vcKey);
      let fileName = vc.icon;
      let imageRef = vcImageDirectory + fileName + ".png"
      let image = document.querySelector(imageElementId);
      image.src = imageRef;
    });
  }

  function updateStatsOnAtkUnitChange(unitKey, dexInputElementId, lukInputElementId) {
    let statsPromise = getUnitLevelStats(unitKey);
    statsPromise.then((values) => {
      stats = values[values.length - 1]
      let dexInput = document.querySelector(dexInputElementId);
      let lukInput = document.querySelector(lukInputElementId);
      dexInput.value = stats.total.dex;
      lukInput.value = stats.total.luk;
      dexInput.dispatchEvent(new Event("change"));
      lukInput.dispatchEvent(new Event("change"));
    });
  }

  function updateStatsOnDefUnitChange(unitKey, agiInputElementId, lukInputElementId) {
    let statsPromise = getUnitLevelStats(unitKey);
    statsPromise.then((values) => {
      stats = values[values.length - 1]
      let agiInput = document.querySelector(agiInputElementId);
      let lukInput = document.querySelector(lukInputElementId);
      agiInput.value = stats.total.spd;
      lukInput.value = stats.total.luk;
      agiInput.dispatchEvent(new Event("change"));
      lukInput.dispatchEvent(new Event("change"));
    });
  }

  function updateStatsOnAtkVisionCardChange(vcKey, dexInputElementId, lukInputElementId) {
    let statsPromise = getVisionCardLevelStats(vcKey);
    statsPromise.then((values) => {
      console.log(values);
    });
    let esperPromise = getEsperLevelStats();
    esperPromise.then((values) => {
      console.log(values);
    })
  }
</script>