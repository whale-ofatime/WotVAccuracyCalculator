---
layout: page
title: WotV Accuracy Calculator
---

<div class="container">
  <div class="row justify-content-md-center">
    <div class="col col-lg-4">
      <h1 class="display-1">Attacker</h1>
      <select id="atkUnitDropdown" class="form-select" aria-label="attack-unit">
        <option selected disabled hidden>Choose Unit</option>
      </select>
      <div class="mt-3">
        <label for="atkDexInput" class="form-label">DEX</label>
        <input type="number" class="form-control" id="atkDexInput" placeholder=0>
      </div>
      <div class="mt-3">
        <label for="atkLukInput" class="form-label">LUK</label>
        <input type="number" class="form-control" id="atkLukInput" placeholder=0>
      </div>
      <div id="accBase">-100</div>
    </div>
    <div class="col col-lg-3 pt-3">
      <h1 class="display-1 text-center"><span id="hitRate" >0</span>%</h1>
    </div>
    <div class="col col-lg-4">
      <h1 class="display-1">Defender</h1>
      <select id="defUnitDropdown" class="form-select" aria-label="defend-unit">
        <option selected disabled hidden>Choose Unit</option>
      </select>
      <div class="mt-3">
        <label for="defAgiInput" class="form-label">AGI</label>
        <input type="number" class="form-control" id="defAgiInput" placeholder=0>
      </div>
      <div class="mt-3">
        <label for="defLukInput" class="form-label">LUK</label>
        <input type="number" class="form-control" id="defLukInput" placeholder=0>
      </div>
      <div id="evaBase">-100</div>
    </div>
  </div>
</div>

<script type="text/javascript" src="./assets/js/helper.js"></script>
<script type="text/javascript" src="./assets/js/wotvfunction.js"></script>

<script>
  // let promiseList = [];
  // // Download json from shalzuth repository at date timestamp
  // let timestamp = (new Date()).getTime();
  // const RAW_GIT_URL = 'https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master';
  // // Data required for this table
  // let files_required = [
  //   '/en/UnitName.json',
  //   '/data/Unit.json'
  // ]
  // files_required.forEach(file => {
  //   promiseList.push($.getJSON(RAW_GIT_URL + file + '?t=' + timestamp, function(data){
  //     console.log("Loaded: " + file);
  //   }));
  // });

  function getAccuracyBase(dex, luk) {
    if (dex < 0 || luk < 0) {
      return -100
    } else {
      return (11*(dex**0.2)/20 + (luk**0.96)/200 - 1)*100
    }
  }
  function getEvasionBase(agi, luk) {
    if (agi < 0 || luk < 0) {
      return -100
    } else {
      return (11*Math.pow(agi,0.9)/1000 + Math.pow(luk,0.96)/200 - 1)*100
    }
  }

  const atkDex = document.querySelector('#atkDexInput');
  const atkLuk = document.querySelector('#atkLukInput');
  const accBase = document.querySelector('#accBase');

  const defAgi = document.querySelector('#defAgiInput');
  const defLuk = document.querySelector('#defLukInput');
  const evaBase = document.querySelector('#evaBase');

  const hitRate = document.querySelector('#hitRate');

  function updateAccBase() {
    const acc = getAccuracyBase(Number(atkDex.value), Number(atkLuk.value)).toFixed(0);
    accBase.textContent = acc;
  }

  function updateEvaBase() {
    const eva = getEvasionBase(Number(defAgi.value), Number(defLuk.value)).toFixed(0);
    evaBase.textContent = eva;
  }

  function updateHitRate() {
    const hit = Number(accBase.textContent) - Number(evaBase.textContent);
    hitRate.textContent = hit;
  }

  atkDex.addEventListener('change', () => {updateAccBase(); updateHitRate();});
  atkLuk.addEventListener('change', () => {updateAccBase(); updateHitRate();});
  defAgi.addEventListener('change', () => {updateEvaBase(); updateHitRate();});
  defLuk.addEventListener('change', () => {updateEvaBase(); updateHitRate();});

  function loadNameDropdown(dropdownElementId) {
    let namePromise = loadJSONPromise('./assets/dump/en/UnitName.json');
    namePromise.then((values) => {
      var nameList = values.infos
      var regex = /_P_/;
      var playerUnits = nameList.filter(unit => regex.test(unit.key));
      var sortedList = playerUnits.sort(dynamicSort("value"));
      var dropdown = document.querySelector(dropdownElementId);
      sortedList.forEach((unit) => {
        var option = document.createElement("option");
        option.value = unit.key;
        option.text = unit.value;
        dropdown.add(option, null);
      });
    });
  }

  loadNameDropdown("#atkUnitDropdown");
  loadNameDropdown("#defUnitDropdown");

  var atkUnitDropdown = document.querySelector("#atkUnitDropdown");
  var defUnitDropdown = document.querySelector("#defUnitDropdown");
  atkUnitDropdown.addEventListener('change', (event) => {updateStatsOnAtkUnitChange(event.target.value, '#atkDexInput', '#atkLukInput');});
  defUnitDropdown.addEventListener('change', (event) => {updateStatsOnDefUnitChange(event.target.value, '#defAgiInput', '#defLukInput');});

  function updateStatsOnAtkUnitChange(unitKey, dexInputElementId, lukInputElementId) {
    let statsPromise = getLevelStats(unitKey);
    statsPromise.then((values) => {
      stats = values[values.length - 1]
      var dexInput = document.querySelector(dexInputElementId);
      var lukInput = document.querySelector(lukInputElementId);
      dexInput.value = stats.total.dex;
      lukInput.value = stats.total.luk;
      dexInput.dispatchEvent(new Event("change"));
      lukInput.dispatchEvent(new Event("change"));
    });
  }

  function updateStatsOnDefUnitChange(unitKey, agiInputElementId, lukInputElementId) {
    let statsPromise = getLevelStats(unitKey);
    statsPromise.then((values) => {
      stats = values[values.length - 1]
      var agiInput = document.querySelector(agiInputElementId);
      var lukInput = document.querySelector(lukInputElementId);
      agiInput.value = stats.total.spd;
      lukInput.value = stats.total.luk;
      agiInput.dispatchEvent(new Event("change"));
      lukInput.dispatchEvent(new Event("change"));
    });
  }

</script>